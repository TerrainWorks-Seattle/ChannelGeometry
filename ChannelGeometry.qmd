---
title: "ChannelGeometry"
format: gfm
---

This document provides a quick look at some of the results reported in Lex's Sprague_Reach_Habitat_updated.csv file. Let's start with the ODFW reach data.

```{r}
library(data.table)
library(stats)
library(ggplot2)
library(patchwork)

datafile <- "/Users/alexahaucke/Documents/GitHub/ChannelGeometry/Sprague_Reach_Habitat_updated.csv"
data <- as.data.table(read.csv(datafile))
reach_width <- data[ACW>0, .(AREA_SQKM, SPRAG14RCH, ACW)]
widths <- reach_width[, .(width = mean(ACW, na.rm = TRUE)), by = SPRAG14RCH]
areas <- reach_width[, .(area = mean(AREA_SQKM, na.rm = TRUE)), by = SPRAG14RCH]
width_reach <- merge(widths, areas, by = "SPRAG14RCH")
p_pnts <- ggplot(width_reach, aes(x=area,y=width)) +
  geom_point(shape=21, size=3, color='black', fill='gray') +
  labs(title="ODFW Reach Width vs Contributing Area",
       x="Contributing Area (sq km)",
       y="Mean Reach Width (m)")
p_box <- ggplot(width_reach, aes(y=width)) +
  geom_boxplot(outlier.color="black", outlier.shape=8, outlier.size=3) +
  labs(title="ODFW Reach Width") +
  theme(axis.title.y = element_blank())
p_pnts + p_box
```
The 17-m wide reach appears to be an outlier compared to the other values. 
```{r}
# Remove the apparent outlier
width_reach <- width_reach[width < 17]

# Fit a power function to the data, starting values from Excel
m_width <- nls(width ~ a * area^b,
               data = width_reach,
               start = list(a = 4.4, b = 0.0354))
m_width

# Plot the data and the fitted line
fit <- predict(m_width, newdata=width_reach)
p_width_reach <- ggplot(width_reach, aes(x=area,y=width)) +
  geom_point(shape=21, size=3, color='black', fill='gray') +
  geom_line(aes(x=width_reach$area, y=fit), linewidth=1.3, color='black') +
  labs(title="ODFW Reach Width vs Contributing Area",
       x="Contributing Area (sq km)",
       y="Mean Reach Width (m)")
p_width_reach
```

```{r}
# Take a look at the channel depth values
reach_depth <- data[ACH>0, .(AREA_SQKM, SPRAG14RCH, ACH)]
depths <- reach_depth[, .(depth = mean(ACH, na.rm = TRUE)), by = SPRAG14RCH]
areas <- reach_depth[, .(area = mean(AREA_SQKM, na.rm = TRUE)), by = SPRAG14RCH]
depth_reach <- merge(depths, areas, by = "SPRAG14RCH")
p_pnts <- ggplot(depth_reach, aes(x=area,y=depth)) +
  geom_point(shape=21, size=3, color='black', fill='gray') +
  labs(title="ODFW Reach Depth vs Contributing Area",
       x="Contributing Area (sq km)",
       y="Mean Reach Depth (m)")
p_pnts
```

Hmm, this shows channel depth decreasing with increasing contributing area. Perhaps they weren't measuring bank-full depth, but including channel incision in their measurements. 

The survey manual suggests that they used bankfull measurements, but there may have been errors in data collection.

Let's compare these results to other survey data.

```{r}
# Stack the widths
width_long <- melt(data, 
                   id.vars = c("SPRAG14RCH", "AREA_SQKM"),
                   measure.vars = c("ACW", "AC_WIDTH", "MaskWidth"),
                   variable.name = "width_type",
                   value.name = "width")
width_long <- width_long[width > 0]

# Then average by reach
width_reach <- width_long[, .(width = mean(width, na.rm = TRUE),
                              area = mean(AREA_SQKM, na.rm = TRUE)), by = SPRAG14RCH]

```

Rerun the model

```{r}
# (Optionally) remove outliers
width_reach <- width_reach[width < 17]

# Fit power model again
m_width <- nls(width ~ a * area^b,
               data = width_reach,
               start = list(a = 4.4, b = 0.0354))
summary(m_width)
```


```{r}
##Create width model
synthetic_width <- function(DA) {
  synthetic_widths <- 4.044*DA^0.08209
  return(synthetic_widths)
}

synthetic_widths <- synthetic_width(areas$area)

```
Castro et al. (2001) created regression models based on contributing areas, as well as width and heights. To compare our model to their model, let's run their model with our contributing area data.

```{r}
# Use equations for western interior basin and ranges, base on figure 4 in Castro & Jackson

# C&J report discharge in cubic feet per second and drainage area in square miles.
# Their Table 4: Q = 13.05*(DA^0.77). We want cubic meters per second 
# as a function of square kilometers. There are 0.0283168 cubic meters per cubic foot.
# There are 0.386102 square miles per square kilometer.
castro_flow <- function(DA) {
  castro_flows = 0.0283168*13.05*((0.386102*DA)^0.77)
  return(castro_flows)
}  

# C&J Table 4: w = 3.27*(DA^0.51), with width (w) in feet and 
# drainage area (DA) in square miles. There are 0.3048 meters per foot.
# To get width in meters: w(m) = (m/ft)*3.27*((sq miles/sq km)*DA(sq km))^0.51
castro_width <- function(DA) {
  castro_widths = 0.3048*3.27*((0.386102*DA)^0.51)
  return(castro_widths)
}  

#C&J Table 4: d = 0.79*(DA^0.24). d in feet, convert to meters
castro_depth <- function(DA) {
  castro_depths = 0.3048*0.79*((0.386102*DA)^0.24)
  return(castro_depths)
}  

castro_widths <- castro_width(areas$area)
castro_depths <- castro_depth(areas$area)

```

To determine the differences between our values and those generated by this model, let's just take a look at the value distributions.

```{r}
hist(castro_widths)

hist(synthetic_widths)

hist(width_long$width)
```
Based on these charts, we can see that the castro widths are mostly above 20 m, which doesn't really make sense based on the surveyed widths. There is a chance that I messed up the unit conversions with Castro, but nothing immediately springs to mind.
